language: clojure
dist: focal
jdk:
  - openjdk11
env:
  global:
  - POSTGRESQL_DB_HOST=localhost
  - POSTGRESQL_DB_PORT=5432
  - POSTGRESQL_DB_USERNAME=postgres
  - POSTGRESQL_DB_PASSWORD=
addons:
  postgresql: "12"
  apt:
    packages:
      - postgresql-12
before_install:
  # Hack needed to have working authententication with the postgres user
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/12/main/pg_hba.conf
  - sudo systemctl restart postgresql@12-main.service
before_script:
  - psql -U postgres -c 'CREATE DATABASE ktra_test;'
  - psql -U postgres ktra_test < db-def.sql
  - cp resources/config.edn_sample resources/config.edn
script:
  - lein test
